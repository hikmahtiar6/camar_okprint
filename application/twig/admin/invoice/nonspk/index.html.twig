{% extends 'admin/layout.html.twig' %}

{% block content_title %}
{% endblock %}

{% block content %}
<div id="app">
<form class="transaction-form" method="POST" action="{{ site_url('admin/invoice/nonspk_save') }}">
	<div class="row clearfix">
		<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
	        <div class="card" style="width: 80%; margin: 0 auto !important;">
	            <div class="header">
	            	<h2>
	            		Form Pengisian Penjualan
	            	</h2>
	            </div>
	            <div class="body" style="padding: 15px">

	            	<div class="row clearfix">

	            		<div class="col-md-12">

	            			<table border="0" cellpadding="0" cellspacing="0" class="" style="width: 100%">
	            				<tr>
	            					<td>
	            						<label>Customer</label>
	            					</td>
	            					<td width="300">
	            						<div class="form-line">
											<input type="text" name="customer_name" class="form-control" value="{{ antrian_data.nama }}" readonly>
											<input type="hidden" name="customer_id" class="form-control" value="{{ antrian_data.customer_id }}" readonly>
            							</div>
	            					</td>
	            					<td width="200" rowspan="4" valign="top" style="padding-left: 10px;">

	            					</td>
	            					<td>
		            					<label>Tgl. Jual</label>
		            				</td>
		            				<td>
            							<div class="form-line">
            								<input class="form-control" type="text" name="tgl_jual" value="{{ "now"|date('Y-m-d') }}">
            							</div>
	            					</td>
	            				</tr>

	            				<tr>
	            					<td>
		            					<label>Nomor SPK</label>
		            				</td>
		            				<td>
            							<div class="form-line">
            								<input class="form-control" type="text" name="no_spk">
            							</div>
		            				</td>
		            				<td>
	            						<label>Status</label>
	            					</td>
	            					<td>

            							<div class="form-line">
            								<select class="form-control" name="status">
            									<option>-Silahkan pilih-</option>
            									<option>Cash</option>
            									<option>Kredit</option>
            								</select>
            							</div>
		            				</td>
	            				</tr>

	            				<tr>
	            					<td>
		            					<label>Nomor Jual</label>
		            				</td>
		            				<td>
            							<div class="form-line">
            								<input class="form-control" type="text" name="no_jual">
            							</div>
		            				</td>

		            				<td>
	            						<label>Jatuh Tempo</label>
	            					</td>
	            					<td>
            							<div class="form-line">
            								<input class="form-control" type="text" name="jatuh_tempo">
            							</div>
		            				</td>
	            				</tr>

	            			</table>




							<br>
							<div class="table-responsive">
							<table class="table table-bordered table-stripped table-hovered">
	            				<thead>
	            					<tr>
	            					<th>
	            						Kode
	            					</th>
	            					<th>
	            						Nama<br>Barang
	            					</th>
	            					<th>
	            						Ket
	            					</th>
	            					<th>
	            						Satuan
	            					</th>
	            					<th>
	            						Qty
	            					</th>
	            					<th>
	            						P
	            					</th>
	            					<th>
	            						L
	            					</th>
	            					<th>
	            						Harga
	            					</th>
	            					<th>
	            						Disc %
	            					</th>
	            					<th>
	            						Disc Rp
	            					</th>
	            					<th>
	            						Jumlah
	            					</th>

	            				</tr>
	            				</thead>

	            				<tbody>
									<template v-for="(detail, index) in details">
	            					<tr>
	            						<td><% detail.kode %></td>
	            						<td><% detail.namaBarang %></td>
	            						<td><input style="width:100px;" type="text" v-model="detail.keterangan"></td>
	            						<td><% detail.satuan %></td>
	            						<td><input style="width:50px;" type="text" v-model="detail.qty" v-on:keyup="calculateJumlah(index)"></td>
	            						<td><input style="width:100px;" type="text" v-model="detail.p" v-on:keyup="calculateJumlah(index)"></td>
	            						<td><input style="width:100px;" type="text" v-model="detail.l" v-on:keyup="calculateJumlah(index)"></td>
	            						<td><% detail.harga %></td>
	            						<td><input style="width:50px;" type="text" name="disc[]" v-model="detail.disc" v-on:keyup="calculateDiscRp(index)"></td>
	            						<td><% detail.discrp %></td>
	            						<td> <% detail.jumlah %><input type="hidden" v-model="detail.token" v-on:keyup="calculateJumlah(index)"></td>
	            					</tr>
									</template>
									<tr>
										<td colspan="11"><a class="btn btn-primary" v-on:click="openBarangList">Tambah Item</a></td>
									</tr>
								</tbody>
	            			</table>
						</div>
	            			<br>

	            			<table cellpadding="0" cellspacing="0" border="0" style="width: 100%">
	            				<tr>
	            					<td valign="top">
		            					<input type="submit" class="btn btn-primary" style="height: 60px;" value="Proses"/>
		            					<button class="btn btn-warning" style="height: 60px;">Tunda</button>
	            					</td>
	            					<td valign="top">
	            						<label>Keterangan</label>
	            						<br>
	            						<textarea name="keterangan_penjualan"></textarea>
	            					</td>
	            					<td>

	            					<table>
	            						<tr>
	            							<td>
	            								<label>Total</label>
	            							</td>
	            							<td style="padding-right: 20px;">
	            								<div class="form-line">
			            							<input class="form-control" name="total">
		            							</div>
	            							</td>
	            							<td>
	            								<label>Netto</label>
	            							</td>
	            							<td>
	            								<div class="form-line">
			            							<input class="form-control" name="netto">
		            							</div>
	            							</td>
	            						</tr>
	            						<tr>
	            							<td>
	            								<label>Discount</label>
	            							</td>
	            							<td style="padding-right: 20px;">
	            								<div class="form-line">
			            							<input class="form-control" name="discount">
		            							</div>
	            							</td>
	            							<td>
	            								<label>Bayar</label>
	            							</td>
	            							<td>
	            								<div class="form-line">
			            							<input class="form-control" name="bayar">
		            							</div>
	            							</td>
	            						</tr>
	            						<tr>
	            							<td>
	            								<label>Charge</label>
	            							</td>
	            							<td style="padding-right: 20px;">
	            								<div class="form-line">
			            							<input class="form-control" name="charge">
		            							</div>
	            							</td>
	            							<td>
	            								<label>Sisa</label>
	            							</td>
	            							<td>
	            								<div class="form-line">
			            							<input class="form-control" name="sisa">
		            							</div>
	            							</td>
	            						</tr>
	            					</table>

	            					</td>
	            				</tr>
	            			</table>

	            			<form>


	            			</form>


	            		</div>

	            	</div>

	            </div>
	        </div>
	    </div>
	 </div>
</form>
<div id="modal-barang" class="modal fade" role="dialog">
  <div class="modal-dialog">

	<!-- Modal content-->
	<div class="modal-content">
	  <div class="modal-header">
		<button type="button" class="close" data-dismiss="modal">&times;</button>
		<h4 class="modal-title">List Barang</h4>
	  </div>
	  <div class="modal-body">
		<table class="table table-stripped table-bordered">
			<thead>
				<tr>
					<th>
						Kode Barang
					</th>
					<th>
						Nama Barang
					</th>
					<th>
						Satuan
					</th>
					<th>
						Harga Jual
					</th>
					<th>
						Action
					</th>
				</tr>
			</thead>
			<tbody>
				{% for barang in barangs %}
					<tr>
						<td>
							{{ barang.kode }}
						</td>
						<td>
							{{ barang.nama }}
						</td>
						<td>
							{{ barang.sat }}
						</td>
						<td>
							{{ barang.harga_jual }}
						</td>
						<td>
							<a class="btn btn-primary" v-on:click='addBarang({{ barang|json_encode }})'>Tambah</a>
						</td>
					</tr>
				{% endfor %}
			</tbody>
		</table>
	  </div>
	  <div class="modal-footer">
		<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	  </div>
	</div>

  </div>
</div>
</div>
{% endblock %}

{% block javascript %}
	{{ parent() }}
	<script type="text/javascript">
	window.APP = new Vue({
		el: '#app',
		delimiters: ["<%","%>"],
		data: {
			detailHolder: {
				barangId: '',
				kode: '',
				namaBarang: '',
				keterangan: '',
				satuan: '',
				qty: '',
				p: '',
				l: '',
				harga: '',
				disc: '',
				discrp: '',
				jumlah: '',
				token: ''
			},
			details: []
		},
		methods: {
			addBarang: function(data) {
				this.detailHolder.barangId = data.tbl_barang_id;
				this.detailHolder.kode = data.kode;
				this.detailHolder.namaBarang = data.nama;
				this.detailHolder.keterangan = '';
				this.detailHolder.satuan = data.sat;
				this.detailHolder.qty = '';
				this.detailHolder.p = '';
				this.detailHolder.l = '';
				this.detailHolder.harga = data.harga_jual;
				this.detailHolder.disc = '';
				this.detailHolder.discrp = 0;
				this.detailHolder.jumlah = 0;
				this.detailHolder.token = '';

				this.addDetail();
			},
			addDetail: function() {
				this.details.push(this.detailHolder);
				this.detailHolder = {};
			},
			openBarangList: function() {
				$("#modal-barang").modal('show');
			},
			calculateDiscRp: function(index) {
				var el = this.details[index];

				el.discrp = (el.harga / 100) * el.disc;
				this.calculateJumlah(index);
			},
			calculateJumlah: function(index) {
				//ngakalin biar semua element bisa autocalculate
				this.details[0].token = Math.random();

				var el = this.details[index];
				el.jumlah = ((el.qty * el.p * el.l) * el.harga) - (el.qty * el.p * el.l) * el.discrp;
			}
		}
	});

	$("form").ajaxForm({
		dataType: 'json',
		success: function(response) {
			swal({
				title: 'Pemberitahuan',
				text: response.message
			});
		}
	});
	</script>
{% endblock %}
